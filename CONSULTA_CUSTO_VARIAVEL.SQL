
select  MES, ANO, COD_FIL,DESC_FIL,
CASE
    WHEN DESC_CAT IS NULL THEN 'SemCategoria'
    
    ELSE DESC_CAT
	END AS DESC_CAT,
	CASE
    WHEN COD_CAT IS NULL THEN '0'
    
    ELSE CAST(COD_CAT as FLOAT) 
	END AS COD_CAT ,

CONTA, ROUND(VALOR,2)
FROM (

SELECT CAST(SUBSTRING( D2_EMISSAO , 5, 2) as INTEGER) as MES, SUBSTRING( D2_EMISSAO , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT, 
 AY0.AY0_DESC AS DESC_CAT ,'510300100003' AS CONTA
, SUM(ROUND(D2_CUSTO1,2)) AS VALOR FROM SM0010 SM0
INNER JOIN SD2010 SD2 ON D2_FILIAL = SM0.FILFULL
INNER JOIN SF4010 SF4 ON F4_CODIGO = D2_TES
INNER JOIN SB1010 SB1 ON B1_COD = D2_COD

LEFT JOIN AY0010 AY0 ON SB1.B1_01CAT5 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE SD2.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' AND SF4.D_E_L_E_T_ = ' ' AND D2_TES IN( '502',
'503',
'504',
'507',
'508',
'519',
'602',
'603',
'605',
'606',
'607',
'608',
'610',
'611',
'683',
'684',
'685',
'687',
'688',
'691',
'700',
'509',
'505')
AND D2_TIPO ='N'
AND F4_DUPLIC='S'AND F4_ESTOQUE='S'
AND D2_EMISSAO BETWEEN '20230101' AND '20230131'
AND D2_FILIAL='010102' --and ltrim(rtrim(D2_CCUSTO))='1.1.012'
group by SUBSTRING( D2_EMISSAO , 5, 2), SUBSTRING( D2_EMISSAO , 1, 4) , SM0.FILFULL ,SM0.FILIAL,AY0_CODIGO,AY0_DESC
) as TMP

ORDER BY MES, ANO, COD_FIL