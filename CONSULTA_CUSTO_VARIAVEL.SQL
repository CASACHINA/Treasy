
select  MES, ANO, COD_FIL,DESC_FIL,
CASE
    WHEN DESC_CAT IS NULL THEN 'SemCategoria'
    
    ELSE DESC_CAT
	END AS DESC_CAT,
	CASE
    WHEN COD_CAT IS NULL THEN '0'
    
    ELSE CAST(COD_CAT as FLOAT) 
	END AS COD_CAT ,

CONTA,CT1_DESC01 ,ROUND(VALOR,2)
FROM (

SELECT CAST(SUBSTRING( D2_EMISSAO , 5, 2) as INTEGER) as MES, SUBSTRING( D2_EMISSAO , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT, 
 AY0.AY0_DESC AS DESC_CAT ,
'510300100003' AS CONTA,
CT1.CT1_DESC01 ,
 SUM(ROUND(D2_CUSTO1,2)) AS VALOR 
 FROM SM0010 SM0
INNER JOIN SD2010 SD2 ON D2_FILIAL = SM0.FILFULL
INNER JOIN SF4010 SF4 ON F4_CODIGO = D2_TES
INNER JOIN SB1010 SB1 ON B1_COD = D2_COD

INNER JOIN CT1010 CT1 ON CT1.CT1_CONTA = '510300100003'  AND CT1.D_E_L_E_T_ = ' '  
LEFT JOIN AY0010 AY0 ON SB1.B1_01CAT5 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE SD2.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' AND SF4.D_E_L_E_T_ = ' ' /*AND D2_TES IN( '502',
'503',
'504',
'507',
'508',
'519',
'602',
'603',
'605',
'606',
'607',
'608',
'610',
'611',
'683',
'684',
'685',
'687',
'688',
'691',
'700',
'509',
'505')*/
AND D2_TIPO ='N'
AND F4_DUPLIC='S'AND F4_ESTOQUE='S'
--AND D2_EMISSAO BETWEEN '20230101' AND '20230131'

AND D2_EMISSAO >=  ${DATA_INICIAL} AND D2_EMISSAO <=  ${DATA_FINAL}
--AND D2_FILIAL='010102' --and ltrim(rtrim(D2_CCUSTO))='1.1.012'
group by SUBSTRING( D2_EMISSAO , 5, 2), SUBSTRING( D2_EMISSAO , 1, 4) , SM0.FILFULL ,SM0.FILIAL,AY0_CODIGO,AY0_DESC,CT1_DESC01

union

select  CAST(SUBSTRING( CT22.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT22.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST('510300100094' as FLOAT) AS COD_CAT,
'DIVERSOS' AS DESC_CAT,
CT22.CT2_DEBITO as CONTA,
CT1.CT1_DESC01,
 SUM(CT2_VALOR) as VALOR
FROM CT2010 CT22

INNER JOIN SM0010 SM0 ON CT2_FILIAL = SM0.FILFULL
INNER JOIN CT1010 CT1 ON CT1.CT1_CONTA = CT22.CT2_DEBITO AND CT1.D_E_L_E_T_ = ' '  
WHERE CT22.D_E_L_E_T_ = ' ' 
--AND CT22.CT2_DATA BETWEEN '20230101' AND '20230131'  
--AND CT2_FILIAL='010102'
AND CT22.CT2_DATA >=  ${DATA_INICIAL} AND CT22.CT2_DATA <=  ${DATA_FINAL}
AND CT22.CT2_LP IN ( '530')
AND CT22.CT2_DEBITO IN  ('510300100001',
'510300100002',
'510300100003',
'510300100005',
'510300100007',
'510300100014',
'510300100015',
'510300100019',
'510300100020',
'510300100096',
'510300100097',
'510300100099',
'510300100100',
'510300100101',
'510300100103',
'510300199999')

GROUP BY SUBSTRING( CT22.CT2_DATA , 5, 2), SUBSTRING( CT22.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL
,CT1.CT1_DESC01,CT22.CT2_DEBITO

UNION 

select  CAST(SUBSTRING( CT22.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT22.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST('510300100092' as FLOAT) AS COD_CAT,
'DIVERSOS' AS DESC_CAT,
CT22.CT2_DEBITO as CONTA,
CT1.CT1_DESC01,
 SUM(CT2_VALOR) as VALOR
FROM CT2010 CT22

INNER JOIN SM0010 SM0 ON CT2_FILIAL = SM0.FILFULL
INNER JOIN CT1010 CT1 ON CT1.CT1_CONTA = CT22.CT2_DEBITO AND CT1.D_E_L_E_T_ = ' '  
WHERE CT22.D_E_L_E_T_ = ' ' 
--AND CT22.CT2_DATA BETWEEN '20230101' AND '20230131'  
--AND CT2_FILIAL='010102'
AND CT22.CT2_DATA >=  ${DATA_INICIAL} AND CT22.CT2_DATA <=  ${DATA_FINAL}
AND CT22.CT2_LP IN ( '   ') AND CT2_HIST LIKE '%QUEBRA/FURTO/DOACAO%'
AND CT22.CT2_DEBITO IN  ('510300100001',
'510300100002',
'510300100003',
'510300100005',
'510300100007',
'510300100014',
'510300100015',
'510300100019',
'510300100020',
'510300100096',
'510300100097',
'510300100099',
'510300100100',
'510300100101',
'510300100103',
'510300199999')

GROUP BY SUBSTRING( CT22.CT2_DATA , 5, 2), SUBSTRING( CT22.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL
,CT1.CT1_DESC01,CT22.CT2_DEBITO

UNION 


select  CAST(SUBSTRING( CT22.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT22.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST('510300100091' as FLOAT) AS COD_CAT,
'DIVERSOS' AS DESC_CAT,
CT22.CT2_DEBITO as CONTA,
CT1.CT1_DESC01,
 SUM(CT2_VALOR) as VALOR
FROM CT2010 CT22

INNER JOIN SM0010 SM0 ON CT2_FILIAL = SM0.FILFULL
INNER JOIN CT1010 CT1 ON CT1.CT1_CONTA = CT22.CT2_DEBITO AND CT1.D_E_L_E_T_ = ' '  
WHERE CT22.D_E_L_E_T_ = ' ' 
--AND CT22.CT2_DATA BETWEEN '20230101' AND '20230131'  
--AND CT2_FILIAL='010102'
AND CT22.CT2_DATA >=  ${DATA_INICIAL} AND CT22.CT2_DATA <=  ${DATA_FINAL}
AND CT22.CT2_LP IN ( '   ') AND CT2_HIST LIKE '%AJUSTE CMV%'
AND CT22.CT2_DEBITO IN  ('510300100001',
'510300100002',
'510300100003',
'510300100005',
'510300100007',
'510300100014',
'510300100015',
'510300100019',
'510300100020',
'510300100096',
'510300100097',
'510300100099',
'510300100100',
'510300100101',
'510300100103',
'510300199999')

GROUP BY SUBSTRING( CT22.CT2_DATA , 5, 2), SUBSTRING( CT22.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL
,CT1.CT1_DESC01,CT22.CT2_DEBITO

UNION 


select  CAST(SUBSTRING( CT22.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT22.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST('510300100093' as FLOAT) AS COD_CAT,
'DIVERSOS' AS DESC_CAT,
CT22.CT2_DEBITO as CONTA,
CT1.CT1_DESC01,
 SUM(CT2_VALOR) as VALOR
FROM CT2010 CT22

INNER JOIN SM0010 SM0 ON CT2_FILIAL = SM0.FILFULL
INNER JOIN CT1010 CT1 ON CT1.CT1_CONTA = CT22.CT2_DEBITO AND CT1.D_E_L_E_T_ = ' '  
WHERE CT22.D_E_L_E_T_ = ' ' 
--AND CT22.CT2_DATA BETWEEN '20230101' AND '20230131'  
--AND CT2_FILIAL='010102'
AND CT22.CT2_DATA >=  ${DATA_INICIAL} AND CT22.CT2_DATA <=  ${DATA_FINAL}
AND CT22.CT2_LP IN ( '572')
AND CT22.CT2_DEBITO IN  ('510300100001',
'510300100002',
'510300100003',
'510300100005',
'510300100007',
'510300100014',
'510300100015',
'510300100019',
'510300100020',
'510300100096',
'510300100097',
'510300100099',
'510300100100',
'510300100101',
'510300100103',
'510300199999')

GROUP BY SUBSTRING( CT22.CT2_DATA , 5, 2), SUBSTRING( CT22.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL
,CT1.CT1_DESC01,CT22.CT2_DEBITO

UNION 

select  CAST(SUBSTRING( CT2.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT2.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT,
AY0.AY0_DESC AS DESC_CAT,
CT2.CT2_DEBITO AS CONTA,
CT1.CT1_DESC01,
 SUM(CV3_VLR01) as VALOR
FROM CT2010 CT2

INNER JOIN CV3010 CV3 ON CT2_LP = CV3_LP AND CT2.CT2_KEY =CV3.CV3_KEY AND CV3.CV3_DEBITO = CT2_DEBITO AND CV3_CREDIT=CT2_CREDIT
INNER JOIN SD1010 SD1 ON CV3.CV3_RECORI = SD1.R_E_C_N_O_
INNER JOIN SB1010 SB1 ON B1_COD = D1_COD
INNER JOIN SM0010 SM0 ON D1_FILIAL = SM0.FILFULL

INNER JOIN CT1010 CT1 ON CT1.CT1_CONTA = CT2.CT2_DEBITO AND CT1.D_E_L_E_T_ = ' '  
LEFT JOIN AY0010 AY0 ON SB1.B1_01CAT5 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE CT2.D_E_L_E_T_ = ' ' AND CV3.D_E_L_E_T_ = ' ' AND SD1.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' 
--AND CT2.CT2_DATA BETWEEN '20230101' AND '20230131'
--AND CT2_FILIAL='010102' 
AND CT2_DATA >=  ${DATA_INICIAL} AND CT2_DATA <=  ${DATA_FINAL}
AND CT2.CT2_LP = '660'
AND CT2.CT2_DEBITO IN('510300100001',
'510300100002',
'510300100003',
'510300100005',
'510300100007',
'510300100014',
'510300100015',
'510300100019',
'510300100020',
'510300100096',
'510300100097',
'510300100099',
'510300100100',
'510300100101',
'510300100103',
'510300199999')

GROUP BY SUBSTRING( CT2.CT2_DATA , 5, 2), SUBSTRING( CT2.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL, AY0.AY0_CODIGO, AY0.AY0_DESC,CT1.CT1_DESC01,CT2.CT2_DEBITO

UNION 
--INVENTARIO ENTRADAS

SELECT CAST(SUBSTRING( D3_EMISSAO , 5, 2) as INTEGER) as MES, SUBSTRING( D3_EMISSAO , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT, 
 AY0.AY0_DESC AS DESC_CAT ,
 '510300100007' AS CONTA,
CT1.CT1_DESC01 ,
SUM(ROUND(D3_CUSTO1  * -1,2)) AS VALOR 
FROM SM0010 SM0
INNER JOIN SD3010 SD2 ON D3_FILIAL = SM0.FILFULL
INNER JOIN SB1010 SB1 ON B1_COD = D3_COD

INNER JOIN CT1010 CT1 ON CT1.CT1_CONTA = '510300100007'  AND CT1.D_E_L_E_T_ = ' '  
LEFT JOIN AY0010 AY0 ON SB1.B1_01CAT5 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE SD2.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' 
AND D3_TM >= 500
--AND D3_EMISSAO BETWEEN '20230101' AND '20230131'

AND D3_EMISSAO >=  ${DATA_INICIAL} AND D3_EMISSAO <=  ${DATA_FINAL}
--AND D3_FILIAL='010102' --and ltrim(rtrim(D2_CCUSTO))='1.1.012'
group by SUBSTRING( D3_EMISSAO , 5, 2), SUBSTRING( D3_EMISSAO , 1, 4) , SM0.FILFULL ,SM0.FILIAL,AY0_CODIGO,AY0_DESC,CT1_DESC01

UNION 

--INVENTARIO 
SELECT CAST(SUBSTRING( D3_EMISSAO , 5, 2) as INTEGER) as MES, SUBSTRING( D3_EMISSAO , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT, 
 AY0.AY0_DESC AS DESC_CAT ,
 '510300100007' AS CONTA,
CT1.CT1_DESC01 ,
SUM(ROUND(D3_CUSTO1,2)) AS VALOR 
FROM SM0010 SM0
INNER JOIN SD3010 SD2 ON D3_FILIAL = SM0.FILFULL
INNER JOIN SB1010 SB1 ON B1_COD = D3_COD

INNER JOIN CT1010 CT1 ON CT1.CT1_CONTA = '510300100007'  AND CT1.D_E_L_E_T_ = ' '  
LEFT JOIN AY0010 AY0 ON SB1.B1_01CAT5 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE SD2.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' 
AND D3_TM < 500
--AND D3_EMISSAO BETWEEN '20230101' AND '20230131'

AND D3_EMISSAO >=  ${DATA_INICIAL} AND D3_EMISSAO <=  ${DATA_FINAL}
--AND D3_FILIAL='010102' --and ltrim(rtrim(D2_CCUSTO))='1.1.012'
group by SUBSTRING( D3_EMISSAO , 5, 2), SUBSTRING( D3_EMISSAO , 1, 4) , SM0.FILFULL ,SM0.FILIAL,AY0_CODIGO,AY0_DESC,CT1_DESC01

UNION

--DEVOLUCOES DE NOTAS


SELECT CAST(SUBSTRING( D1_EMISSAO , 5, 2) as INTEGER) as MES, SUBSTRING( D1_EMISSAO , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT, 
 AY0.AY0_DESC AS DESC_CAT ,
'510300100003' AS CONTA,
CT1.CT1_DESC01 ,
 SUM(ROUND(D1_CUSTO * -1,2)) AS VALOR 
 FROM SM0010 SM0
INNER JOIN SD1010 SD1 ON D1_FILIAL = SM0.FILFULL
INNER JOIN SF4010 SF4 ON F4_CODIGO = D1_TES
INNER JOIN SB1010 SB1 ON B1_COD = D1_COD

INNER JOIN CT1010 CT1 ON CT1.CT1_CONTA = '510300100003'  AND CT1.D_E_L_E_T_ = ' '  
LEFT JOIN AY0010 AY0 ON SB1.B1_01CAT5 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE SD1.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' AND SF4.D_E_L_E_T_ = ' ' 
AND D1_TIPO ='D'
--AND F4_DUPLIC='S'AND F4_ESTOQUE='S'
--AND D1_EMISSAO BETWEEN '20230101' AND '20230131'

AND D1_EMISSAO >=  ${DATA_INICIAL} AND D1_EMISSAO <=  ${DATA_FINAL}
--AND D1_FILIAL='010102' --and ltrim(rtrim(D2_CCUSTO))='1.1.012'
group by SUBSTRING( D1_EMISSAO , 5, 2), SUBSTRING( D1_EMISSAO , 1, 4) , SM0.FILFULL ,SM0.FILIAL,AY0_CODIGO,AY0_DESC,CT1_DESC01


)


as TMP

ORDER BY MES, ANO, COD_FIL
