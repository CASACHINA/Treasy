

select  COUNT(*)
FROM (
select  CAST(SUBSTRING( CT22.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT22.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT,
AY0.AY0_DESC AS DESC_CAT, SUM(D2_QUANT) AS QUANTIDADE,AVG(D2_PRCVEN) as Preco_Unitario , SUM(CV3_VLR01) as Valor_total
FROM CT2010 CT22

INNER JOIN CV3010 CV3 ON CT2_LP = CV3_LP AND  CT22.CT2_SEQUEN =CV3.CV3_SEQUEN AND CV3.CV3_DEBITO = CT2_DEBITO AND CV3_CREDIT=CT2_CREDIT
INNER JOIN SD2010 SD2 ON CV3.CV3_RECORI = SD2.R_E_C_N_O_
INNER JOIN SB1010 SB1 ON B1_COD = D2_COD
INNER JOIN SM0010 SM0 ON D2_FILIAL = SM0.FILFULL
LEFT JOIN AY0010 AY0 ON SB1.B1_01CAT5 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE CT22.D_E_L_E_T_ = ' ' AND CV3.D_E_L_E_T_ = ' ' AND SD2.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' 
AND CT22.CT2_DATA BETWEEN '20220101' AND '20220131'  AND CT2_FILIAL='010102'
--AND CT2_DATA >=  ${DATA_INICIAL} AND CT2_DATA <=  ${DATA_FINAL}
AND CT22.CT2_LP = '610'
AND CT22.CT2_DEBITO IN ('410300100003',
'410300100004',
'410300100005',
'410300500002',
'410300500004',
'410300500005',
'410300500009',
'410300500010',
'410300500016',
'410300500017',
'410300500018',
'410500300010',
'410500300012') 

GROUP BY SUBSTRING( CT22.CT2_DATA , 5, 2), SUBSTRING( CT22.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL, AY0.AY0_CODIGO, AY0.AY0_DESC

UNION
select  CAST(SUBSTRING( CT2.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT2.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT,
AY0.AY0_DESC AS DESC_CAT, SUM(D1_QUANT) AS QUANTIDADE,AVG(D1_VUNIT) as Preco_Unitario , SUM(CV3_VLR01) as Valor_total
FROM CT2010 CT2

INNER JOIN CV3010 CV3 ON CT2_LP = CV3_LP AND CT2.CT2_KEY =CV3.CV3_KEY AND CV3.CV3_DEBITO = CT2_DEBITO AND CV3_CREDIT=CT2_CREDIT
INNER JOIN SD1010 SD1 ON CV3.CV3_RECORI = SD1.R_E_C_N_O_
INNER JOIN SB1010 SB1 ON B1_COD = D1_COD
INNER JOIN SM0010 SM0 ON D1_FILIAL = SM0.FILFULL
LEFT JOIN AY0010 AY0 ON SB1.B1_01CAT5 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE CT2.D_E_L_E_T_ = ' ' AND CV3.D_E_L_E_T_ = ' ' AND SD1.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' 
AND CT2.CT2_DATA BETWEEN '20220101' AND '20220131' AND CT2_FILIAL='010102'
AND CT2.CT2_FILIAL='010102'
--AND CT2_DATA >=  ${DATA_INICIAL} AND CT2_DATA <=  ${DATA_FINAL}
AND CT2.CT2_LP = '640'
AND CT2.CT2_DEBITO IN ('410300100003',
'410300100004',
'410300100005',
'410300500002',
'410300500004',
'410300500005',
'410300500009',
'410300500010',
'410300500016',
'410300500017',
'410300500018',
'410500300010',
'410500300012') 

GROUP BY SUBSTRING( CT2.CT2_DATA , 5, 2), SUBSTRING( CT2.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL, AY0.AY0_CODIGO, AY0.AY0_DESC
) as TMP