select  MES, ANO, COD_FIL,DESC_FIL,
CASE
    WHEN DESC_CAT IS NULL THEN 'SemCategoria'
    
    ELSE DESC_CAT
	END AS DESC_CAT,
	CASE
    WHEN COD_CAT IS NULL THEN '0'
    
    ELSE CAST(COD_CAT as FLOAT) 
	END AS COD_CAT 

--,QUANTIDADE, (Valor_total/QUANTIDADE) as Preco_unitario
, Valor_total,CT1_DESC01,CT2_DEBITO
FROM (
select  CAST(SUBSTRING( CT22.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT22.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT,
CT1.CT1_DESC01,CT22.CT2_DEBITO,
AY0.AY0_DESC AS DESC_CAT, SUM(D2_QUANT) AS QUANTIDADE,AVG(D2_PRCVEN) as Preco_Unitario , SUM(CV3_VLR01) as Valor_total
FROM CT2010 CT22  WITH (NOLOCK)

INNER JOIN CV3010 CV3  WITH (NOLOCK) ON CT2_LP = CV3_LP AND  CT22.CT2_SEQUEN =CV3.CV3_SEQUEN AND CV3.CV3_DEBITO = CT2_DEBITO AND CV3_CREDIT=CT2_CREDIT
INNER JOIN SD2010 SD2 WITH (NOLOCK) ON CV3.CV3_RECORI = SD2.R_E_C_N_O_
INNER JOIN SB1010 SB1 WITH (NOLOCK) ON B1_COD = D2_COD
INNER JOIN SM0010 SM0 WITH (NOLOCK) ON D2_FILIAL = SM0.FILFULL
INNER JOIN CT1010 CT1 WITH (NOLOCK) ON CT1.CT1_CONTA = CT22.CT2_DEBITO AND CT1.D_E_L_E_T_ = ' '  
LEFT JOIN AY0010 AY0 WITH (NOLOCK) ON SB1.B1_01CAT2 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE CT22.D_E_L_E_T_ = ' ' AND CV3.D_E_L_E_T_ = ' ' AND SD2.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' 
--AND CT22.CT2_DATA BETWEEN '20230101' AND '20230131'  --AND CT2_FILIAL='010102'
AND CT2_DATA >=  ${DATA_INICIAL} AND CT2_DATA <=  ${DATA_FINAL}
AND CT22.CT2_LP = '610'
AND CT22.CT2_DEBITO IN ('410300100003',
'410300100004',
'410300100005',
'410300500002',
'410300500004',
'410300500005',
'410300500009',
'410300500010',
'410300500016',
'410300500017',
'410300500018',
'410500300010',
'410500300012') 

GROUP BY SUBSTRING( CT22.CT2_DATA , 5, 2), SUBSTRING( CT22.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL, AY0.AY0_CODIGO, AY0.AY0_DESC
,CT1.CT1_DESC01,CT22.CT2_DEBITO
UNION
select  CAST(SUBSTRING( CT2.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT2.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT,

CT1.CT1_DESC01,CT2.CT2_DEBITO,
AY0.AY0_DESC AS DESC_CAT, SUM(D1_QUANT) AS QUANTIDADE,AVG(D1_VUNIT) as Preco_Unitario , SUM(CV3_VLR01) as Valor_total
FROM CT2010 CT2 WITH (NOLOCK) 

INNER JOIN CV3010 CV3 WITH (NOLOCK) ON CV3.CV3_RECDES = CT2.R_E_C_N_O_
INNER JOIN SD1010 SD1 WITH (NOLOCK) ON CV3.CV3_RECORI = SD1.R_E_C_N_O_
INNER JOIN SB1010 SB1 WITH (NOLOCK) ON B1_COD = D1_COD
INNER JOIN SM0010 SM0 WITH (NOLOCK) ON D1_FILIAL = SM0.FILFULL

INNER JOIN CT1010 CT1 WITH (NOLOCK) ON CT1.CT1_CONTA = CT2.CT2_DEBITO AND CT1.D_E_L_E_T_ = ' '  
LEFT JOIN AY0010 AY0 WITH (NOLOCK) ON SB1.B1_01CAT2 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE CT2.D_E_L_E_T_ = ' ' AND CV3.D_E_L_E_T_ = ' ' AND SD1.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' 
--AND CT2.CT2_DATA BETWEEN '20230101' AND '20230131'-- AND CT2_FILIAL='010102' 
AND CT2_DATA >=  ${DATA_INICIAL} AND CT2_DATA <=  ${DATA_FINAL}
AND CT2.CT2_LP = '640'
AND CT2.CT2_DEBITO IN ('410300100003',
'410300100004',
'410300100005',
'410300500002',
'410300500004',
'410300500005',
'410300500009',
'410300500010',
'410300500016',
'410300500017',
'410300500018',
'410500300010',
'410500300012') 

GROUP BY SUBSTRING( CT2.CT2_DATA , 5, 2), SUBSTRING( CT2.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL, AY0.AY0_CODIGO, AY0.AY0_DESC,CT1.CT1_DESC01,CT2.CT2_DEBITO


union 

-- IMC PIS E COF  CREDORES
select  CAST(SUBSTRING( CT2.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT2.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT,

CT1.CT1_DESC01,CT2.CT2_CREDIT,
AY0.AY0_DESC AS DESC_CAT, SUM(D1_QUANT) AS QUANTIDADE,AVG(D1_VUNIT) as Preco_Unitario , SUM(CV3_VLR01 *-1) as Valor_total
FROM CT2010 CT2

INNER JOIN CV3010 CV3  WITH (NOLOCK) ON CV3.CV3_RECDES = CT2.R_E_C_N_O_
INNER JOIN SD1010 SD1 WITH (NOLOCK) ON CV3.CV3_RECORI = SD1.R_E_C_N_O_
INNER JOIN SB1010 SB1 WITH (NOLOCK) ON B1_COD = D1_COD
INNER JOIN SM0010 SM0 WITH (NOLOCK) ON D1_FILIAL = SM0.FILFULL

INNER JOIN CT1010 CT1 WITH (NOLOCK) ON CT1.CT1_CONTA = CT2.CT2_CREDIT AND CT1.D_E_L_E_T_ = ' '  
LEFT JOIN AY0010 AY0 WITH (NOLOCK) ON SB1.B1_01CAT2 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE CT2.D_E_L_E_T_ = ' ' AND CV3.D_E_L_E_T_ = ' ' AND SD1.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' 
--AND CT2.CT2_DATA BETWEEN '20230101' AND '20230131'-- AND CT2_FILIAL='010102' 
AND CT2_DATA >=  ${DATA_INICIAL} AND CT2_DATA <=  ${DATA_FINAL}
AND CT2.CT2_LP = '640' and CT2_CREDIT in ('410300100003',
'410300100004',
'410300100005',
'410300500002',
'410300500004',
'410300500005',
'410300500009',
'410300500010',
'410300500016',
'410300500017',
'410300500018',
'410500300010',
'410500300012')


GROUP BY SUBSTRING( CT2.CT2_DATA , 5, 2), SUBSTRING( CT2.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL, AY0.AY0_CODIGO, AY0.AY0_DESC,CT1.CT1_DESC01,CT2.CT2_CREDIT

union 
--difal

select  CAST(SUBSTRING( CT22.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT22.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST('9995' as FLOAT) AS COD_CAT,
'ICMS DIFAL SOB VENDAS INTERESTADUAIS' AS DESC_CAT,
CT22.CT2_DEBITO as CONTA,
CT1.CT1_DESC01,
1 as QUANTIDADE,
 SUM(CT2_VALOR) AS PRC_UN,
 SUM(CT2_VALOR) as VALOR
FROM CT2010 CT22 WITH (NOLOCK) 

INNER JOIN SM0010 SM0 WITH (NOLOCK) ON CT2_FILIAL = SM0.FILFULL
INNER JOIN CT1010 CT1 WITH (NOLOCK) ON CT1.CT1_CONTA = CT22.CT2_DEBITO AND CT1.D_E_L_E_T_ = ' '  
WHERE CT22.D_E_L_E_T_ = ' ' 
--0AND CT22.CT2_DATA BETWEEN '20230101' AND '20230131'  
--AND CT2_FILIAL='010102'
AND CT22.CT2_DATA >=  ${DATA_INICIAL} AND CT22.CT2_DATA <=  ${DATA_FINAL}
AND CT22.CT2_LP IN ( '510')
AND CT22.CT2_DEBITO IN  ('410300500017')

GROUP BY SUBSTRING( CT22.CT2_DATA , 5, 2), SUBSTRING( CT22.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL
,CT1.CT1_DESC01,CT22.CT2_DEBITO


union 

select  CAST(SUBSTRING( CT22.CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT22.CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST('9995' as FLOAT) AS COD_CAT,
'ICMS DIFAL SOB VENDAS INTERESTADUAIS' AS DESC_CAT,
CT22.CT2_CREDIT as CONTA,
CT1.CT1_DESC01,
1 as QUANTIDADE,
 SUM(CT2_VALOR) AS PRC_UN,
 SUM(CT2_VALOR *-1) as VALOR
FROM CT2010 CT22 WITH (NOLOCK) 

INNER JOIN SM0010 SM0 WITH (NOLOCK) ON CT2_FILIAL = SM0.FILFULL
INNER JOIN CT1010 CT1 WITH (NOLOCK) ON CT1.CT1_CONTA = CT22.CT2_CREDIT AND CT1.D_E_L_E_T_ = ' '  
WHERE CT22.D_E_L_E_T_ = ' ' 
--AND CT22.CT2_DATA BETWEEN '20230101' AND '20230131'  
--AND CT2_FILIAL='010102'
AND CT22.CT2_DATA >=  ${DATA_INICIAL} AND CT22.CT2_DATA <=  ${DATA_FINAL}
AND CT22.CT2_LP IN ( '510')
AND CT22.CT2_CREDIT IN  ('410300500017')

GROUP BY SUBSTRING( CT22.CT2_DATA , 5, 2), SUBSTRING( CT22.CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL
,CT1.CT1_DESC01,CT22.CT2_CREDIT

) as TMP

ORDER BY MES, ANO, COD_FIL