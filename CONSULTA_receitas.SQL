
select  MES, ANO, COD_FIL,DESC_FIL,
CASE
    WHEN DESC_CAT IS NULL THEN 'SemCategoria'
    
    ELSE DESC_CAT
	END AS DESC_CAT,
	CASE
    WHEN COD_CAT IS NULL THEN '0'
    
    ELSE CAST(COD_CAT as FLOAT) 
	END AS COD_CAT ,

QUANTIDADE, (Valor_total/QUANTIDADE) as Preco_unitario
FROM (
select  CAST(SUBSTRING( CT2_DATA , 5, 2) as INTEGER) as MES, SUBSTRING( CT2_DATA , 1, 4) AS ANO ,SM0.FILFULL AS COD_FIL,SM0.FILIAL AS DESC_FIL, 
CAST(AY0.AY0_CODIGO as FLOAT) AS COD_CAT,
AY0.AY0_DESC AS DESC_CAT, SUM(D2_QUANT) AS QUANTIDADE,AVG(D2_PRCVEN) as Preco_Unitario , SUM(CV3_VLR01) as Valor_total
FROM CT2010 CT2 WITH (NOLOCK)

INNER JOIN CV3010 CV3 WITH (NOLOCK) ON CT2_LP = CV3_LP AND CT2.CT2_SEQUEN =CV3.CV3_SEQUEN AND CV3.CV3_DEBITO = CT2_DEBITO AND CV3_CREDIT=CT2_CREDIT
INNER JOIN SD2010 SD2 WITH (NOLOCK) ON CV3.CV3_RECORI = SD2.R_E_C_N_O_
INNER JOIN SB1010 SB1 WITH (NOLOCK) ON B1_COD = D2_COD
INNER JOIN SM0010 SM0 WITH (NOLOCK) ON D2_FILIAL = SM0.FILFULL
LEFT JOIN AY0010 AY0 WITH (NOLOCK) ON SB1.B1_01CAT5 =AY0.AY0_CODIGO AND AY0.D_E_L_E_T_ = ' '
WHERE CT2.D_E_L_E_T_ = ' ' AND CV3.D_E_L_E_T_ = ' ' AND SD2.D_E_L_E_T_ = ' ' AND SB1.D_E_L_E_T_ = ' ' 
--AND CT2_DATA BETWEEN '20220101' AND '20220131' 
AND CT2_DATA >=  ${DATA_INICIAL} 
		AND CT2_DATA <=  ${DATA_FINAL} 
AND CT2_CREDIT='410100300001001'

GROUP BY SUBSTRING( CT2_DATA , 5, 2), SUBSTRING( CT2_DATA , 1, 4) ,SM0.FILFULL ,SM0.FILIAL, AY0.AY0_CODIGO, AY0.AY0_DESC
) as TMP

ORDER BY MES, ANO, COD_FIL